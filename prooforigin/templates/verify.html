{% extends "base.html" %}
{% block title %}Vérifier une preuve · ProofOrigin{% endblock %}
{% block content %}
<section class="glass-card" style="padding: 2.4rem;">
    <h1 class="section-title">Vérification publique</h1>
    <p class="section-subtitle">Hash : <code id="verify-hash">{{ file_hash }}</code></p>
    <div id="verify-status" class="glass-card" style="padding: 1.5rem; gap: 0.75rem;">
        <p>Chargement du statut…</p>
    </div>
    <div style="display:flex; gap:1rem; flex-wrap:wrap;">
        <a id="download-link" class="btn btn-secondary" href="#" style="display:none;">Télécharger le certificat PDF</a>
        <a class="btn btn-ghost" href="/">← Revenir à l'accueil</a>
    </div>
</section>
<script>
(async function verify() {
    const hash = document.getElementById('verify-hash').textContent.trim();
    try {
        const response = await fetch(`/verify/${hash}`, { headers: { 'Accept': 'application/json' } });
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        const statusEl = document.getElementById('verify-status');
        statusEl.innerHTML = '';
        const status = document.createElement('p');
        status.textContent = data.status === 'verified' ? '✅ Preuve vérifiée' : '❌ Aucune preuve trouvée pour ce hash';
        statusEl.appendChild(status);
        if (data.created_at) {
            const created = document.createElement('p');
            created.textContent = `Créée le : ${new Date(data.created_at).toLocaleString()}`;
            statusEl.appendChild(created);
        }
        if (data.owner) {
            const owner = document.createElement('p');
            owner.textContent = `Propriétaire : ${data.owner.display_name || data.owner.email || data.owner.id}`;
            statusEl.appendChild(owner);
        }
        if (data.blockchain_tx) {
            const link = document.createElement('a');
            const explorerBase = 'https://polygonscan.com/tx/';
            link.href = data.blockchain_tx.startsWith('http') ? data.blockchain_tx : `${explorerBase}${data.blockchain_tx}`;
            link.href = `https://polygonscan.com/tx/${data.blockchain_tx}`;
            link.target = '_blank';
            link.rel = 'noreferrer';
            link.textContent = 'Voir la transaction blockchain';
            statusEl.appendChild(link);
        }
        if (data.download_url) {
            const btn = document.getElementById('download-link');
            btn.href = data.download_url;
            btn.style.display = 'inline-flex';
        }
    } catch (error) {
        document.getElementById('verify-status').textContent = `Erreur de vérification : ${error}`;
    }
})();
</script>
{% endblock %}
